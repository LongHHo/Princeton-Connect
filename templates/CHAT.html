<!DOCTYPE html>
<html>
   <head>
      <title>Chat</title>
   </head>
   <style>
   div.left{
      position:relative; 
      float: left;
      width: 300px;
      height: 900px;
     
      overflow: auto;
}

div.right{
      position:relative; 
      float: right;
      width: 800px;
      height: 900px;
      overflow: auto;
}
div.names{
   border: solid;
   background-color: lightblue;
   margin: 4px;
}

div.messageSend{
   border: solid; 
   margin: 8px;
   width: 200px;
   background-color: lightgoldenrodyellow;
}

div.messageRecieve{
   border: solid; 
   margin: 8px;
   width: 200px;
   background-color: lightcoral;
}


textarea{
    
   width:350px; 
}
div.MessagesContainer{
   overflow: auto;
   height:70%;
   width:100%;

}

div.ContactContainer{
   overflow: auto;
   height:90%;
   width:100%;

}


#NewMessage{

   box-shadow:2px 10px 30px;
   position: fixed;
   display: none;
   right: 50%;
   width:600px;
   z-index: 1000;
   background-color: white;


}




   </style>
  
   <body>


<div id="NewMessage">
   
            <input type="text" placeholder="NetID" name="NetID" id="netid" list="userData" oninput="available_users()"></input>

            <datalist id="userData">
            </datalist>
            <p></p>

            <textarea name="message" placeholder="message" id="message"> </textarea> 
            
            <button onclick="send_message();document.getElementById('NewMessage').style.display='none';" id="sendNewMessage"> send </button> 
         
         <div onclick="document.getElementById('NewMessage').style.display='none'">
            <button align="center">Cancel</button>
         </div>
      </div>
   <div class="left">
      <h3>People</h3>
         <div onclick="document.getElementById('NewMessage').style.display='block'">
               <button align="center">New Message</button>
            </div>
      
      <div class="ContactContainer" id ="cc">
      
   </div>
</div>

   <div class="right"> 
         <h3>Messages</h3>
      <div class="MessagesContainer" id="mc">
            
      </div>
     
      <textarea class="textType" placeholder="Message"></textarea>


   
   </div>

   <script src=
      "https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js">
    </script>
  
  <script>

function setup()
  {
   getContacts();
  }


function handleResponse(response)
  {
   button = document.getElementById('sendNewMessage');
   text = document.getElementById('netid').value; 
  
   //if (response == '') button.disabled = true 
   //else button.disabled = false;
    $('#userData').html(response); // change id 
    var obj = $("#userData").find("option[value='" + text + "']");
    if(obj != null && obj.length > 0){
      button.disabled = false;
    }

   else{
      button.disabled = true;
   }
    
  
  }


let request = null;
  function available_users(){
   
   var netid = document.getElementById('netid').value;
   netid = encodeURIComponent(netid); 
   let url = "/checkUser?netid=" + netid
    
    if (request != null){
      request.abort();
    }

    request = $.ajax(
      {
        type: "GET",
        url: url,
        success: handleResponse
      }
    );



  }


  function send_message(){
     var reciever = document.getElementById('netid').value;
     reciever = encodeURIComponent(reciever); 
     var message = document.getElementById('message').value;
     message = encodeURIComponent(message); 

     let url = "/sendMessage?reciever=" + reciever + "&message=" + message

     r = $.ajax(
      {
        type: "GET",
        url: url,
      }
    );

     

  }

  

  function getMessages(contact){
     cntct =  encodeURIComponent(contact);
     let url = "/getMessages?contact=" + cntct 

     r = $.ajax(
      {
        type: "GET",
        url: url,
        success: handleMessages
      }
    );

     


  }

  function getContacts(){

   var contacts = {{ contactsData|tojson }};

   contacts = JSON.parse(contacts);

   data = '';

   for(i = 0; i < contacts.length; i++ ){

      data = data + '<div class="names" id=' +  JSON.stringify(contacts[i]) + ' onclick= "getMessages(' + '\'' + contacts[i] + '\'' + ')" >' + contacts[i] + '</div>';
                                                                                                                    
      }

      $('#cc').html(data);

   for(i = 0; i < contacts.length; i++ ){

         data = data + '<div class="names" id=' +  JSON.stringify(contacts[i]) + '>' + contacts[i] + '</div>';
         
         }


   




  }

function handleMessages(messagesData){


var messages = JSON.parse(messagesData);
var id = messages[0];

data = ''
for (i = 0; i < messages[1].length; i++){

   if(messages[1][i][0] == id){
      data = data + '<div class="messageSend">' + messages[1][i][1] +  '</div>'; 
      }

   else{
      data = data + '<div class="messageRecieve">' + messages[1][i][1] +  '</div>'; 
   }

}

$('#mc').html(data);




}

  $('document').ready(setup);
  
  
  </script>
 


         
      
      
      
   </body>
</html>